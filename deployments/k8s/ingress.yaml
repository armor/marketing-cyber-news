---
# Ingress for armor-newsletter services
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: armor-newsletter
  namespace: armor-newsletter
  labels:
    app.kubernetes.io/name: armor-newsletter
    app.kubernetes.io/component: ingress
  annotations:
    # Ingress class: nginx (for minikube: minikube addons enable ingress)
    kubernetes.io/ingress.class: "nginx"
    # Request size limits
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    # Timeouts
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    # WebSocket support (for n8n)
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$request_uri"
spec:
  rules:
    - host: newsletter.local
      http:
        paths:
          # API routes -> Backend
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: aci-backend
                port:
                  name: http
          - path: /v1
            pathType: Prefix
            backend:
              service:
                name: aci-backend
                port:
                  name: http
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: aci-backend
                port:
                  name: http
          # n8n UI and webhooks
          - path: /n8n
            pathType: Prefix
            backend:
              service:
                name: n8n
                port:
                  name: http
          - path: /webhook
            pathType: Prefix
            backend:
              service:
                name: n8n
                port:
                  name: http
          # Mailpit UI
          - path: /mail
            pathType: Prefix
            backend:
              service:
                name: mailpit
                port:
                  name: http
          # Frontend (catch-all - must be last)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: aci-frontend
                port:
                  name: http

---
# Alternative: Direct access without ingress (using NodePorts)
# Access services directly via minikube IP:
#   Frontend: http://$(minikube ip):30080
#   Backend:  http://$(minikube ip):30808
#   n8n:      http://$(minikube ip):30567
#   Mailpit:  http://$(minikube ip):30825
#   Postgres: $(minikube ip):30432
